# An example Mbed project for implementing HAR on Hexiwear

Before trying this project out, it may be easier to get [this simple NN] working (the guide is for developing in MacOS). It has a more thorough guide on how to setup an Mbed/uTensor project from scratch. Just replace `K66F` with `hexiwear` when compiling.

## HexiwearHARExample Quick-start

Tested on macOS. To get it working on Ubuntu, you will have to jump through some hoops to get Mercurial installed (need version >= 4.7, 4.5.2 is installed by default on Ubuntu 18.02).

To get everything working, install the following:

  - [Python 3.7]
  - [Mbed-cli]: follow instructions on page to install. Make sure you set up the `ARM_PATH`.
  - [uTensor-cli]: `pip install utensor_cgen` should work.
  - [CoolTerm]: for serial communication

Once everything is installed, all you should need to do is:

```sh
mbed deploy
make all
```

Known issue: if `mbed deploy` raises a `'utf-8' codec` error, refer to [this issue] for the fix.

Then, just drag and drop the binary file located at `BUILD/HEXIWEAR/GCC_ARM-RELEASE/HexiwearHARExample.bin` to Hexiwear (`DAPLINK/`).

Configure CoolTerm (find the correct serial port and set baud rate to 115200), and press the reset button on the docking station. The collected sensor data should be printed, followed by the expected activity.

## Project overview

NOTE: In `mbed_app.json`, the stack size is set to 8000. The default value is 4000, which caused memory faults because the data vector was too large. Feel free to size up if necessary, as Hexiwear has plenty of memory.

### `main.cpp`

#### Includes

Only the necessary sensor libraries were included. The NN code generated by uTensor was also included.

#### Main code

Time-series data is collected from the accelerometer and gyroscope. 128 data points are collected at a rate of 50 Hz, and the data is flattened and put into an array called `input_data[]`. The accelerometer data has an unwanted gravity component, which we filter out using a high-pass filter. I used the methodology from [this article] to filter it out. I took 72 data samples before the 128 in order to make sure the gravity filter values were stable.

The data is then printed over serial, and then the NN is used to evaluate the expected label for the data, which is also printed over serial.

### [CoolTerm]

In `Options`, find the `Port` corresponding to Hexiwear (probably something like `/dev/tty.usbmodem[PORT]` if using Linux). If it isn't there, try to re-scan serial ports. The default baud rate I used was 115200. 

### Sensors

The sensor libraries included in this project and their descriptions are listed below. Only the accelerometer and gyroscope sensor data were used for human activity recognition, but other libraries are included to allow for easier code re-use.

| Library | Description |
| --------- | ----------- |
| FXAS21002 | Used to retrieve gyroscope sensor data |
| FXOS8700 | Used to retrieve accelerometer and magnetometer data |
| Hexi_KW40Z | (UNUSED) Used for Bluetooth low energy (BLE) connectivity |
| Hexi_OLED_SSD1351 | (UNUSED) Used to toggle LEDs on Hexiwear |
| MPL3155A2 | (UNUSED) Used to retrieve Barometric pressure and altitude |

### Makefile

Hopefully most of the Makefile is relatively self-explanatory.

Change the variable `NN` to be the name of the `.pb` file without the file extension.

The variable `OUTPUT_NODE` should be the name of the output variable of the NN in the TensorFlow code. Default `y_pred`.

| make [command] | Description |
| all | Runs `make models && make compile` |
| compile | Runs the mbed compile command, which will only recompile necessary files. |
| models | Converts the NN `.pb` file to C++ files and outputs them to the `models/` directory. Also prints the include to put in `main.cpp`. |
| evalcode | Just prints the code to put in the main body of `main.cpp` to actually perform the neural network computation. |
| clean | Removes all of the `BUILD/` directory from Mbed compile. Removes the models in the `models/` directory. This must be run you change the name of the NN file and want to add it to `main.cpp`. |

[//]: # (These are reference links used in the body of this note and get stripped out when the markdown processor does its job. There is no need to format nicely because it shouldn't be seen. Thanks SO - http://stackoverflow.com/questions/4823468/store-comments-in-markdown-syntax)

   [Mbed-cli]: <https://os.mbed.com/docs/mbed-os/v5.11/tools/installation-and-setup.html>
   [uTensor-cli]: <https://github.com/uTensor/utensor_cgen>
   [Python 3.7]: <https://www.python.org/downloads/>
   [CoolTerm]: <http://freeware.the-meiers.org/>
   [this simple NN]: <https://blog.hackster.io/simple-neural-network-on-mcus-a7cbd3dc108c>
   [this article]: <https://developer.android.com/reference/android/hardware/SensorEvent.html#values>
   [this issue]: <https://github.com/ARMmbed/mbed-cli/issues/859> 